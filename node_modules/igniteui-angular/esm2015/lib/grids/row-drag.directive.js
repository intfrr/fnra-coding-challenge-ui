import { Directive, Input, NgModule, TemplateRef } from '@angular/core';
import { IgxDragDirective } from '../directives/drag-drop/drag-drop.directive';
import { fromEvent } from 'rxjs';
import * as ɵngcc0 from '@angular/core';
const ghostBackgroundClass = 'igx-grid__tr--ghost';
const gridCellClass = 'igx-grid__td';
const rowSelectedClass = 'igx-grid__tr--selected';
const cellSelectedClass = 'igx-grid__td--selected';
const cellActiveClass = 'igx-grid__td--active';
/**
 * @hidden
 */
export class IgxRowDragDirective extends IgxDragDirective {
    constructor() {
        super(...arguments);
        this._rowDragStarted = false;
        this.transitionEndEvent = (evt) => {
            if (this.ghostElement) {
                this.ghostElement.removeEventListener('transitionend', this.transitionEndEvent, false);
            }
            this.endDragging();
        };
    }
    get row() {
        return this.data;
    }
    onPointerDown(event) {
        event.preventDefault();
        this._rowDragStarted = false;
        this._removeOnDestroy = false;
        super.onPointerDown(event);
    }
    onPointerMove(event) {
        super.onPointerMove(event);
        if (this._dragStarted && !this._rowDragStarted) {
            this._rowDragStarted = true;
            const args = {
                dragDirective: this,
                dragData: this.row,
                cancel: false,
                owner: this.row.grid
            };
            this.row.grid.onRowDragStart.emit(args);
            if (args.cancel) {
                this.ghostElement.parentNode.removeChild(this.ghostElement);
                this.ghostElement = null;
                this._dragStarted = false;
                this._clicked = false;
                return;
            }
            this.row.grid.dragRowID = this.row.rowID;
            this.row.grid.rowDragging = true;
            this.row.grid.markForCheck();
            this.subscription$ = fromEvent(this.row.grid.document.defaultView, 'keydown').subscribe((ev) => {
                if (ev.key === "Escape" /* ESCAPE */ || ev.key === "Esc" /* ESCAPE_IE */) {
                    this._lastDropArea = false;
                    this.onPointerUp(event);
                }
            });
        }
    }
    onPointerUp(event) {
        if (!this._clicked) {
            return;
        }
        const args = {
            dragDirective: this,
            dragData: this.row,
            animation: false,
            owner: this.row.grid
        };
        this.zone.run(() => {
            this.row.grid.onRowDragEnd.emit(args);
        });
        const dropArea = this._lastDropArea;
        super.onPointerUp(event);
        if (!dropArea && this.ghostElement) {
            this.ghostElement.addEventListener('transitionend', this.transitionEndEvent, false);
        }
        else {
            this.endDragging();
        }
    }
    createGhost(pageX, pageY) {
        this.row.grid.endEdit(true);
        this.row.grid.markForCheck();
        this.ghostContext = {
            $implicit: this.row.rowData,
            data: this.row.rowData,
            grid: this.row.grid
        };
        super.createGhost(pageX, pageY, this.row.nativeElement);
        // check if there is an expander icon and create the ghost at the corresponding position
        if (this.isHierarchicalGrid) {
            const row = this.row;
            if (row.expander) {
                const expanderWidth = row.expander.nativeElement.getBoundingClientRect().width;
                this._ghostHostX += expanderWidth;
            }
        }
        const ghost = this.ghostElement;
        const gridRect = this.row.grid.nativeElement.getBoundingClientRect();
        const rowRect = this.row.nativeElement.getBoundingClientRect();
        ghost.style.overflow = 'hidden';
        ghost.style.width = gridRect.width + 'px';
        ghost.style.height = rowRect.height + 'px';
        this.renderer.addClass(ghost, ghostBackgroundClass);
        this.renderer.removeClass(ghost, rowSelectedClass);
        const ghostCells = ghost.getElementsByClassName(gridCellClass);
        for (let index = 0; index < ghostCells.length; index++) {
            this.renderer.removeClass(ghostCells[index], cellSelectedClass);
            this.renderer.removeClass(ghostCells[index], cellActiveClass);
        }
    }
    _unsubscribe() {
        if (this.subscription$ && !this.subscription$.closed) {
            this.subscription$.unsubscribe();
        }
    }
    endDragging() {
        this.onTransitionEnd(null);
        this.row.grid.dragRowID = null;
        this.row.grid.rowDragging = false;
        this.row.grid.markForCheck();
        this._unsubscribe();
    }
    get isHierarchicalGrid() {
        return this.row.grid.nativeElement.tagName.toLowerCase() === 'igx-hierarchical-grid';
    }
}
IgxRowDragDirective.ɵfac = function IgxRowDragDirective_Factory(t) { return ɵIgxRowDragDirective_BaseFactory(t || IgxRowDragDirective); };
IgxRowDragDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: IgxRowDragDirective, selectors: [["", "igxRowDrag", ""]], inputs: { data: ["igxRowDrag", "data"] }, features: [ɵngcc0.ɵɵInheritDefinitionFeature] });
IgxRowDragDirective.propDecorators = {
    data: [{ type: Input, args: ['igxRowDrag',] }]
};
const ɵIgxRowDragDirective_BaseFactory = /*@__PURE__*/ ɵngcc0.ɵɵgetInheritedFactory(IgxRowDragDirective);
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(IgxRowDragDirective, [{
        type: Directive,
        args: [{
                selector: '[igxRowDrag]'
            }]
    }], null, { data: [{
            type: Input,
            args: ['igxRowDrag']
        }] }); })();
/**
 * @hidden
 */
export class IgxDragIndicatorIconDirective {
}
IgxDragIndicatorIconDirective.ɵfac = function IgxDragIndicatorIconDirective_Factory(t) { return new (t || IgxDragIndicatorIconDirective)(); };
IgxDragIndicatorIconDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: IgxDragIndicatorIconDirective, selectors: [["", "igxDragIndicatorIcon", ""]] });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(IgxDragIndicatorIconDirective, [{
        type: Directive,
        args: [{
                selector: '[igxDragIndicatorIcon]'
            }]
    }], null, null); })();
/**
 * @hidden
 */
export class IgxRowDragGhostDirective {
    constructor(templateRef) {
        this.templateRef = templateRef;
    }
}
IgxRowDragGhostDirective.ɵfac = function IgxRowDragGhostDirective_Factory(t) { return new (t || IgxRowDragGhostDirective)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.TemplateRef)); };
IgxRowDragGhostDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: IgxRowDragGhostDirective, selectors: [["", "igxRowDragGhost", ""]] });
IgxRowDragGhostDirective.ctorParameters = () => [
    { type: TemplateRef }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(IgxRowDragGhostDirective, [{
        type: Directive,
        args: [{
                selector: '[igxRowDragGhost]'
            }]
    }], function () { return [{ type: ɵngcc0.TemplateRef }]; }, null); })();
export class IgxRowDragModule {
}
IgxRowDragModule.ɵmod = ɵngcc0.ɵɵdefineNgModule({ type: IgxRowDragModule });
IgxRowDragModule.ɵinj = ɵngcc0.ɵɵdefineInjector({ factory: function IgxRowDragModule_Factory(t) { return new (t || IgxRowDragModule)(); }, imports: [[]] });
(function () { (typeof ngJitMode === "undefined" || ngJitMode) && ɵngcc0.ɵɵsetNgModuleScope(IgxRowDragModule, { declarations: [IgxRowDragDirective, IgxDragIndicatorIconDirective, IgxRowDragGhostDirective], exports: [IgxRowDragDirective, IgxDragIndicatorIconDirective, IgxRowDragGhostDirective] }); })();
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(IgxRowDragModule, [{
        type: NgModule,
        args: [{
                declarations: [IgxRowDragDirective, IgxDragIndicatorIconDirective, IgxRowDragGhostDirective],
                entryComponents: [],
                exports: [IgxRowDragDirective, IgxDragIndicatorIconDirective, IgxRowDragGhostDirective],
                imports: []
            }]
    }], null, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm93LWRyYWcuZGlyZWN0aXZlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9pZ25pdGV1aS1hbmd1bGFyL3NyYy9saWIvZ3JpZHMvcm93LWRyYWcuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFhLFFBQVEsRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sNkNBQTZDLENBQUM7QUFFL0UsT0FBTyxFQUFFLFNBQVMsRUFBZ0IsTUFBTSxNQUFNLENBQUM7O0FBTy9DLE1BQU0sb0JBQW9CLEdBQUcscUJBQXFCLENBQUM7QUFDbkQsTUFBTSxhQUFhLEdBQUcsY0FBYyxDQUFDO0FBQ3JDLE1BQU0sZ0JBQWdCLEdBQUcsd0JBQXdCLENBQUM7QUFDbEQsTUFBTSxpQkFBaUIsR0FBRyx3QkFBd0IsQ0FBQztBQUNuRCxNQUFNLGVBQWUsR0FBRyxzQkFBc0IsQ0FBQztBQUUvQztBQUNBO0FBQ0EsR0FBRztBQUlILE1BQU0sT0FBTyxtQkFBb0IsU0FBUSxnQkFBZ0I7QUFBRyxJQUg1RDtBQUNHO0FBRUgsUUFFWSxvQkFBZSxHQUFHLEtBQUssQ0FBQztBQUNwQyxRQTBIWSx1QkFBa0IsR0FBRyxDQUFDLEdBQUksRUFBRSxFQUFFO0FBQzFDLFlBQVEsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO0FBQy9CLGdCQUFZLElBQUksQ0FBQyxZQUFZLENBQUMsbUJBQW1CLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUNuRyxhQUFTO0FBQ1QsWUFBUSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7QUFDM0IsUUFBSSxDQUFDLENBQUE7QUFDTCxJQUlBLENBQUM7QUFDRCxJQXJJSSxJQUFZLEdBQUc7QUFBSyxRQUNoQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7QUFD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O0FBQ0E7QUFDQSxHQUFHO0FBS0gsTUFBTSxPQUFPLDZCQUE2QjtBQUMxQzt5REFMQyxTQUFTLFNBQUMsa0JBQ1AsUUFBUSxFQUFFLHdCQUF3QixjQUNyQzs7Ozs7OzswQkFFRztBQUdKO0FBQ0E7QUFDQSxHQUFHO0FBS0gsTUFBTSxPQUFPLHdCQUF3QjtBQUFHLElBQ3BDLFlBQW1CLFdBQTZCO0FBQUksUUFBakMsZ0JBQVcsR0FBWCxXQUFXLENBQWtCO0FBQUMsSUFBRyxDQUFDO0FBQ3pEO29EQU5DLFNBQVMsU0FBQyxrQkFDUCxRQUFRLEVBQUUsbUJBQW1CLGNBQ2hDO3VJQUVHO0FBQUM7QUFDUyxZQWpMa0MsV0FBVztBQUFHOzs7Ozs7NEVBQUU7QUEyTGhFLE1BQU0sT0FBTyxnQkFBZ0I7QUFDN0I7NENBUkMsUUFBUSxTQUFDO0VBQ04sWUFBWSxFQUFFLENBQUMsbUJBQW1CLEVBQUUsNkJBQTZCLEVBQUUsd0JBQXdCLENBQUMsa0JBQzVGLGVBQWUsRUFBRSxFQUFFLGtCQUNuQixPQUFPO0NBQUUsQ0FBQyxtQkFBbUIsRUFBRSw2QkFBNkIsRUFBRSx3QkFBd0IsQ0FBQyxrQkFDdkYsT0FBTyxFQUFFLEVBQUUsY0FDZDs7Ozs7Ozs7OzBCQUVHO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIElucHV0LCBPbkRlc3Ryb3ksIE5nTW9kdWxlLCBUZW1wbGF0ZVJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSWd4RHJhZ0RpcmVjdGl2ZSB9IGZyb20gJy4uL2RpcmVjdGl2ZXMvZHJhZy1kcm9wL2RyYWctZHJvcC5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgS0VZUyB9IGZyb20gJy4uL2NvcmUvdXRpbHMnO1xuaW1wb3J0IHsgZnJvbUV2ZW50LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IElneFJvd0RpcmVjdGl2ZSwgSWd4R3JpZEJhc2VEaXJlY3RpdmUgfSBmcm9tICcuL2dyaWQvcHVibGljX2FwaSc7XG5pbXBvcnQgeyBJUm93RHJhZ1N0YXJ0RXZlbnRBcmdzLCBJUm93RHJhZ0VuZEV2ZW50QXJncyB9IGZyb20gJy4vY29tbW9uL2V2ZW50cyc7XG5pbXBvcnQgeyBHcmlkVHlwZSB9IGZyb20gJy4vY29tbW9uL2dyaWQuaW50ZXJmYWNlJztcbmltcG9ydCB7IElneEhpZXJhcmNoaWNhbFJvd0NvbXBvbmVudCB9IGZyb20gJy4vaGllcmFyY2hpY2FsLWdyaWQvaGllcmFyY2hpY2FsLXJvdy5jb21wb25lbnQnO1xuXG5cbmNvbnN0IGdob3N0QmFja2dyb3VuZENsYXNzID0gJ2lneC1ncmlkX190ci0tZ2hvc3QnO1xuY29uc3QgZ3JpZENlbGxDbGFzcyA9ICdpZ3gtZ3JpZF9fdGQnO1xuY29uc3Qgcm93U2VsZWN0ZWRDbGFzcyA9ICdpZ3gtZ3JpZF9fdHItLXNlbGVjdGVkJztcbmNvbnN0IGNlbGxTZWxlY3RlZENsYXNzID0gJ2lneC1ncmlkX190ZC0tc2VsZWN0ZWQnO1xuY29uc3QgY2VsbEFjdGl2ZUNsYXNzID0gJ2lneC1ncmlkX190ZC0tYWN0aXZlJztcblxuLyoqXG4gKiBAaGlkZGVuXG4gKi9cbkBEaXJlY3RpdmUoe1xuICAgIHNlbGVjdG9yOiAnW2lneFJvd0RyYWddJ1xufSlcbmV4cG9ydCBjbGFzcyBJZ3hSb3dEcmFnRGlyZWN0aXZlIGV4dGVuZHMgSWd4RHJhZ0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gICAgcHJpdmF0ZSBzdWJzY3JpcHRpb24kOiBTdWJzY3JpcHRpb247XG4gICAgcHJpdmF0ZSBfcm93RHJhZ1N0YXJ0ZWQgPSBmYWxzZTtcbiAgICBwcml2YXRlIGdldCByb3coKTogSWd4Um93RGlyZWN0aXZlPElneEdyaWRCYXNlRGlyZWN0aXZlICYgR3JpZFR5cGU+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGF0YTtcbiAgICB9XG5cbiAgICBASW5wdXQoJ2lneFJvd0RyYWcnKVxuICAgIHB1YmxpYyBkYXRhOiBhbnk7XG5cbiAgICBwdWJsaWMgb25Qb2ludGVyRG93bihldmVudCkge1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB0aGlzLl9yb3dEcmFnU3RhcnRlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9yZW1vdmVPbkRlc3Ryb3kgPSBmYWxzZTtcbiAgICAgICAgc3VwZXIub25Qb2ludGVyRG93bihldmVudCk7XG4gICAgfVxuXG4gICAgcHVibGljIG9uUG9pbnRlck1vdmUoZXZlbnQpIHtcbiAgICAgICAgc3VwZXIub25Qb2ludGVyTW92ZShldmVudCk7XG4gICAgICAgIGlmICh0aGlzLl9kcmFnU3RhcnRlZCAmJiAhdGhpcy5fcm93RHJhZ1N0YXJ0ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuX3Jvd0RyYWdTdGFydGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIGNvbnN0IGFyZ3M6IElSb3dEcmFnU3RhcnRFdmVudEFyZ3MgPSB7XG4gICAgICAgICAgICAgICAgZHJhZ0RpcmVjdGl2ZTogdGhpcyxcbiAgICAgICAgICAgICAgICBkcmFnRGF0YTogdGhpcy5yb3csXG4gICAgICAgICAgICAgICAgY2FuY2VsOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBvd25lcjogdGhpcy5yb3cuZ3JpZFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgdGhpcy5yb3cuZ3JpZC5vblJvd0RyYWdTdGFydC5lbWl0KGFyZ3MpO1xuICAgICAgICAgICAgaWYgKGFyZ3MuY2FuY2VsKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5naG9zdEVsZW1lbnQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzLmdob3N0RWxlbWVudCk7XG4gICAgICAgICAgICAgICAgdGhpcy5naG9zdEVsZW1lbnQgPSBudWxsO1xuICAgICAgICAgICAgICAgIHRoaXMuX2RyYWdTdGFydGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdGhpcy5fY2xpY2tlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMucm93LmdyaWQuZHJhZ1Jvd0lEID0gdGhpcy5yb3cucm93SUQ7XG4gICAgICAgICAgICB0aGlzLnJvdy5ncmlkLnJvd0RyYWdnaW5nID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMucm93LmdyaWQubWFya0ZvckNoZWNrKCk7XG5cbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uJCA9IGZyb21FdmVudCh0aGlzLnJvdy5ncmlkLmRvY3VtZW50LmRlZmF1bHRWaWV3LCAna2V5ZG93bicpLnN1YnNjcmliZSgoZXY6IEtleWJvYXJkRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXYua2V5ID09PSBLRVlTLkVTQ0FQRSB8fCBldi5rZXkgPT09IEtFWVMuRVNDQVBFX0lFKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2xhc3REcm9wQXJlYSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uUG9pbnRlclVwKGV2ZW50KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBvblBvaW50ZXJVcChldmVudCkge1xuXG4gICAgICAgIGlmICghdGhpcy5fY2xpY2tlZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYXJnczogSVJvd0RyYWdFbmRFdmVudEFyZ3MgPSB7XG4gICAgICAgICAgICBkcmFnRGlyZWN0aXZlOiB0aGlzLFxuICAgICAgICAgICAgZHJhZ0RhdGE6IHRoaXMucm93LFxuICAgICAgICAgICAgYW5pbWF0aW9uOiBmYWxzZSxcbiAgICAgICAgICAgIG93bmVyOiB0aGlzLnJvdy5ncmlkXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yb3cuZ3JpZC5vblJvd0RyYWdFbmQuZW1pdChhcmdzKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgZHJvcEFyZWEgPSB0aGlzLl9sYXN0RHJvcEFyZWE7XG4gICAgICAgIHN1cGVyLm9uUG9pbnRlclVwKGV2ZW50KTtcbiAgICAgICAgaWYgKCFkcm9wQXJlYSAmJiB0aGlzLmdob3N0RWxlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5naG9zdEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndHJhbnNpdGlvbmVuZCcsIHRoaXMudHJhbnNpdGlvbkVuZEV2ZW50LCBmYWxzZSk7XG4gICAgICAgIH0gICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZW5kRHJhZ2dpbmcoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBjcmVhdGVHaG9zdChwYWdlWCwgcGFnZVkpIHtcbiAgICAgICAgdGhpcy5yb3cuZ3JpZC5lbmRFZGl0KHRydWUpO1xuICAgICAgICB0aGlzLnJvdy5ncmlkLm1hcmtGb3JDaGVjaygpO1xuICAgICAgICB0aGlzLmdob3N0Q29udGV4dCA9IHtcbiAgICAgICAgICAgICRpbXBsaWNpdDogdGhpcy5yb3cucm93RGF0YSxcbiAgICAgICAgICAgIGRhdGE6IHRoaXMucm93LnJvd0RhdGEsXG4gICAgICAgICAgICBncmlkOiB0aGlzLnJvdy5ncmlkXG4gICAgICAgIH07XG4gICAgICAgIHN1cGVyLmNyZWF0ZUdob3N0KHBhZ2VYLCBwYWdlWSwgdGhpcy5yb3cubmF0aXZlRWxlbWVudCk7XG5cbiAgICAgICAgLy8gY2hlY2sgaWYgdGhlcmUgaXMgYW4gZXhwYW5kZXIgaWNvbiBhbmQgY3JlYXRlIHRoZSBnaG9zdCBhdCB0aGUgY29ycmVzcG9uZGluZyBwb3NpdGlvblxuICAgICAgICBpZiAodGhpcy5pc0hpZXJhcmNoaWNhbEdyaWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHJvdyA9IHRoaXMucm93IGFzIElneEhpZXJhcmNoaWNhbFJvd0NvbXBvbmVudDtcbiAgICAgICAgICAgIGlmIChyb3cuZXhwYW5kZXIpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBleHBhbmRlcldpZHRoID0gcm93LmV4cGFuZGVyLm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGg7XG4gICAgICAgICAgICAgICAgdGhpcy5fZ2hvc3RIb3N0WCArPSBleHBhbmRlcldpZHRoO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZ2hvc3QgPSB0aGlzLmdob3N0RWxlbWVudDtcblxuICAgICAgICBjb25zdCBncmlkUmVjdCA9IHRoaXMucm93LmdyaWQubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgICAgY29uc3Qgcm93UmVjdCA9IHRoaXMucm93Lm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICAgIGdob3N0LnN0eWxlLm92ZXJmbG93ID0gJ2hpZGRlbic7XG4gICAgICAgIGdob3N0LnN0eWxlLndpZHRoID0gZ3JpZFJlY3Qud2lkdGggKyAncHgnO1xuICAgICAgICBnaG9zdC5zdHlsZS5oZWlnaHQgPSByb3dSZWN0LmhlaWdodCArICdweCc7XG5cbiAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyhnaG9zdCwgZ2hvc3RCYWNrZ3JvdW5kQ2xhc3MpO1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKGdob3N0LCByb3dTZWxlY3RlZENsYXNzKTtcblxuICAgICAgICBjb25zdCBnaG9zdENlbGxzID0gZ2hvc3QuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShncmlkQ2VsbENsYXNzKTtcbiAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGdob3N0Q2VsbHMubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKGdob3N0Q2VsbHNbaW5kZXhdLCBjZWxsU2VsZWN0ZWRDbGFzcyk7XG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKGdob3N0Q2VsbHNbaW5kZXhdLCBjZWxsQWN0aXZlQ2xhc3MpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfdW5zdWJzY3JpYmUoKSB7XG4gICAgICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbiQgJiYgIXRoaXMuc3Vic2NyaXB0aW9uJC5jbG9zZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uJC51bnN1YnNjcmliZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBlbmREcmFnZ2luZygpIHtcbiAgICAgICAgdGhpcy5vblRyYW5zaXRpb25FbmQobnVsbCk7XG4gICAgICAgIHRoaXMucm93LmdyaWQuZHJhZ1Jvd0lEID0gbnVsbDtcbiAgICAgICAgdGhpcy5yb3cuZ3JpZC5yb3dEcmFnZ2luZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLnJvdy5ncmlkLm1hcmtGb3JDaGVjaygpO1xuICAgICAgICB0aGlzLl91bnN1YnNjcmliZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgdHJhbnNpdGlvbkVuZEV2ZW50ID0gKGV2dD8pID0+IHtcbiAgICAgICAgaWYgKHRoaXMuZ2hvc3RFbGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmdob3N0RWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0cmFuc2l0aW9uZW5kJywgdGhpcy50cmFuc2l0aW9uRW5kRXZlbnQsIGZhbHNlKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmVuZERyYWdnaW5nKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgaXNIaWVyYXJjaGljYWxHcmlkKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5yb3cuZ3JpZC5uYXRpdmVFbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2lneC1oaWVyYXJjaGljYWwtZ3JpZCc7XG4gICAgfVxufVxuXG4vKipcbiAqIEBoaWRkZW5cbiAqL1xuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6ICdbaWd4RHJhZ0luZGljYXRvckljb25dJ1xufSlcblxuZXhwb3J0IGNsYXNzIElneERyYWdJbmRpY2F0b3JJY29uRGlyZWN0aXZlIHtcbn1cblxuLyoqXG4gKiBAaGlkZGVuXG4gKi9cbkBEaXJlY3RpdmUoe1xuICAgIHNlbGVjdG9yOiAnW2lneFJvd0RyYWdHaG9zdF0nXG59KVxuXG5leHBvcnQgY2xhc3MgSWd4Um93RHJhZ0dob3N0RGlyZWN0aXZlICB7XG4gICAgY29uc3RydWN0b3IocHVibGljIHRlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxhbnk+KSB7IH1cbn1cblxuQE5nTW9kdWxlKHtcbiAgICBkZWNsYXJhdGlvbnM6IFtJZ3hSb3dEcmFnRGlyZWN0aXZlLCBJZ3hEcmFnSW5kaWNhdG9ySWNvbkRpcmVjdGl2ZSwgSWd4Um93RHJhZ0dob3N0RGlyZWN0aXZlXSxcbiAgICBlbnRyeUNvbXBvbmVudHM6IFtdLFxuICAgIGV4cG9ydHM6IFtJZ3hSb3dEcmFnRGlyZWN0aXZlLCBJZ3hEcmFnSW5kaWNhdG9ySWNvbkRpcmVjdGl2ZSwgSWd4Um93RHJhZ0dob3N0RGlyZWN0aXZlXSxcbiAgICBpbXBvcnRzOiBbXVxufSlcblxuZXhwb3J0IGNsYXNzIElneFJvd0RyYWdNb2R1bGUge1xufVxuIl19